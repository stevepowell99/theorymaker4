<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Theorymaker</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="./favicon.svg" />

    <!-- Bootstrap (styling only; no build step) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />

    <!-- Bootstrap Icons (single-file icon font) -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />

    <!-- Title font (modern + distinctive, used only for the app brand text) -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@600;700&display=swap" />

    <!-- App styling -->
    <link rel="stylesheet" href="./styles.css" />

    <!-- Intro.js (guided tour) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intro.js@7.2.0/minified/introjs.min.css" />
  </head>

  <body>
    <!-- Simple navbar -->
    <nav class="navbar navbar-expand-lg navbar-light border-bottom bg-white">
      <div class="container-fluid">
        <a class="navbar-brand fw-semibold tm-brand" href="#">theorymaker</a>

        <!-- Mobile: hamburger menu for switching between screens -->
        <button
          class="navbar-toggler d-lg-none ms-2"
          type="button"
          data-bs-toggle="offcanvas"
          data-bs-target="#tm-mobile-nav"
          aria-controls="tm-mobile-nav"
          aria-label="Open menu"
        >
          <span class="navbar-toggler-icon" aria-hidden="true"></span>
        </button>

        <!-- History controls: mirrors browser back/forward (discrete undo/redo) -->
        <div class="ms-auto d-flex align-items-center gap-2">
          <div class="btn-group btn-group-sm" role="group" aria-label="History controls">
            <button
              id="tm-undo"
              class="btn btn-outline-secondary tm-icon-btn"
              type="button"
              aria-label="Undo"
              data-bs-toggle="tooltip"
              data-bs-title="Undo (back)"
            >
              <i class="bi bi-arrow-counterclockwise" aria-hidden="true"></i>
            </button>
            <button
              id="tm-redo"
              class="btn btn-outline-secondary tm-icon-btn"
              type="button"
              aria-label="Redo"
              data-bs-toggle="tooltip"
              data-bs-title="Redo (forward)"
            >
              <i class="bi bi-arrow-clockwise" aria-hidden="true"></i>
            </button>
          </div>

          <!-- Guided tour -->
          <button
            id="tm-tour"
            class="btn btn-outline-secondary btn-sm tm-icon-btn"
            type="button"
            aria-label="Tour"
            data-bs-toggle="tooltip"
            data-bs-title="Tour"
          >
            <i class="bi bi-magic" aria-hidden="true"></i>
          </button>
        </div>
      </div>
    </nav>

    <!-- Mobile: offcanvas navigation (single-screen mode) -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="tm-mobile-nav" aria-labelledby="tm-mobile-nav-label">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title tm-brand" id="tm-mobile-nav-label">theorymaker</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
        <div class="list-group">
          <button type="button" class="list-group-item list-group-item-action" data-tm-screen="chat">Chat</button>
          <button type="button" class="list-group-item list-group-item-action" data-tm-screen="editor">Editor</button>
          <button type="button" class="list-group-item list-group-item-action" data-tm-screen="diagram">Diagram</button>
          <button type="button" class="list-group-item list-group-item-action" data-tm-screen="templates">Templates</button>
          <button type="button" class="list-group-item list-group-item-action" data-tm-screen="help">Help</button>
        </div>
      </div>
    </div>

    <!-- Main layout: editor | splitter | right panel -->
    <main class="tm-main">
      <!-- Left: Chat (default) + Editor (behind chevron) -->
      <section id="tm-left" class="tm-left">
        <!-- Chat UI -->
        <div id="tm-chat-panel" class="tm-panel-header border-bottom bg-white px-2 py-2">
          <div class="d-flex align-items-center justify-content-between gap-2">
          </div>

          <!-- Chat thread: hidden until first message; grows up to ~40% viewport height then scrolls -->
          <div id="tm-chat-thread" class="tm-chat-thread d-none" aria-label="Chat history"></div>

          <div class="input-group input-group-sm mt-2">
            <textarea
              id="tm-chat-input"
              class="form-control tm-chat-input"
              rows="2"
              placeholder="Chat with AI to create a new diagram or update the existing diagram: contents and/or styles. Or click on the diagram to edit it, or use the manual editor below."
              aria-label="Chat input"
            ></textarea>
            <button
              id="tm-chat-clear"
              class="btn btn-outline-secondary d-none"
              type="button"
              title="Clear chat history"
              aria-label="Clear chat history"
            >
              Clear
            </button>
            <button
              id="tm-chat-stop"
              class="btn btn-outline-danger d-none"
              type="button"
              title="Stop"
              aria-label="Stop"
            >
              Stop
            </button>
            <button id="tm-chat-send" class="btn btn-primary" type="button">
              <span id="tm-chat-send-label">Send</span>
              <span id="tm-chat-send-spinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
            </button>
          </div>
        </div>

        <!-- Editor hidden behind a chevron (per request) -->
        <details id="tm-editor-details" class="tm-details tm-editor-details">
          <summary class="tm-details-summary tm-editor-details-summary">
            <i class="bi bi-chevron-right tm-chevron" aria-hidden="true"></i>
            <span class="fw-semibold">editor</span>
          </summary>

          <div class="tm-editor-wrap">
            <div id="editor" class="tm-editor" aria-label="Theory DSL editor"></div>
          </div>
        </details>
      </section>

      <!-- Draggable splitter -->
      <div id="tm-splitter" class="tm-splitter" role="separator" aria-orientation="vertical" aria-label="Resize editor"></div>

      <!-- Right: tabs + content -->
      <section id="tm-right" class="tm-right">
        <div class="tm-tabs border-bottom bg-white px-2 py-2">
          <!-- Per spec: tabs are “just text along the top” -->
          <a href="#" class="tm-tab active" data-tab="viz">diagram</a>
          <span class="text-muted px-1">|</span>
          <a href="#" class="tm-tab" data-tab="templates">templates</a>
          <span class="text-muted px-1">|</span>
          <a href="#" class="tm-tab" data-tab="help">help</a>
        </div>

        <div class="tm-right-body">
          <!-- Viz tab -->
          <section id="tab-viz" class="tm-tab-panel">
            <div class="p-2 border-bottom bg-white">
              <div id="tm-errors" class="tm-errors d-none"></div>
            </div>
            <div class="tm-viz-wrap" aria-label="Graph visualization output">
              <!-- Controls across the top of the Graphviz output (per spec) -->
              <div class="tm-viz-toolbar border-bottom bg-white px-2 py-2">
                <div class="tm-toolbar-group">
                  <div class="btn-group btn-group-sm" role="group" aria-label="Map controls">
                    <button
                      id="tm-zoom-out"
                      class="btn btn-outline-secondary tm-icon-btn"
                      type="button"
                      aria-label="Zoom out"
                      data-bs-toggle="tooltip"
                      data-bs-title="Zoom out"
                    >
                      <i class="bi bi-zoom-out" aria-hidden="true"></i>
                    </button>
                    <button
                      id="tm-zoom-reset"
                      class="btn btn-outline-secondary tm-icon-btn"
                      type="button"
                      aria-label="Reset zoom"
                      data-bs-toggle="tooltip"
                      data-bs-title="Reset zoom"
                    >
                      <i class="bi bi-arrow-repeat" aria-hidden="true"></i>
                    </button>
                    <button
                      id="tm-zoom-in"
                      class="btn btn-outline-secondary tm-icon-btn"
                      type="button"
                      aria-label="Zoom in"
                      data-bs-toggle="tooltip"
                      data-bs-title="Zoom in"
                    >
                      <i class="bi bi-zoom-in" aria-hidden="true"></i>
                    </button>
                  </div>
                </div>

                <div class="vr mx-2 align-self-stretch"></div>

                <div class="tm-toolbar-group">
                  <div class="btn-group btn-group-sm" role="group">
                    <button
                      class="btn btn-outline-secondary dropdown-toggle tm-icon-btn"
                      type="button"
                      data-bs-toggle="dropdown"
                      aria-expanded="false"
                      aria-label="Save and share options"
                    >
                      <i class="bi bi-floppy" aria-hidden="true"></i>
                    </button>
                    <ul class="dropdown-menu">
                      <li><h6 class="dropdown-header">Save</h6></li>
                      <li>
                        <button
                          id="tm-editor-save"
                          class="dropdown-item"
                          type="button"
                          data-bs-toggle="tooltip"
                          data-bs-placement="left"
                          data-bs-title="Save to this browser"
                        >
                          <i class="bi bi-floppy me-2" aria-hidden="true"></i>Save to this browser
                        </button>
                      </li>
                      <li><hr class="dropdown-divider"></li>
                      <li><h6 class="dropdown-header">Copy to clipboard</h6></li>
                      <li>
                        <button
                          id="tm-copy-raw-url"
                          class="dropdown-item"
                          type="button"
                          data-bs-toggle="tooltip"
                          data-bs-placement="left"
                          data-bs-title="Copy a plain link (URL) that restores this map."
                        >
                          <i class="bi bi-clipboard me-2" aria-hidden="true"></i>Plain Link
                        </button>
                      </li>
                      <li>
                        <button
                          id="tm-copy-link"
                          class="dropdown-item"
                          type="button"
                          data-bs-toggle="tooltip"
                          data-bs-placement="left"
                          data-bs-title="Copy a clickable formatted link (HTML) plus the plain URL."
                        >
                          <i class="bi bi-link-45deg me-2" aria-hidden="true"></i>Formatted link
                        </button>
                      </li>
                      <li>
                        <button
                          id="tm-download-png"
                          class="dropdown-item"
                          type="button"
                          data-bs-toggle="tooltip"
                          data-bs-placement="left"
                          data-bs-title="Copy a PNG image to the clipboard (great for slides/docs)."
                        >
                          <i class="bi bi-image me-2" aria-hidden="true"></i>PNG image
                        </button>
                      </li>
                      <li>
                        <button
                          id="tm-download-html"
                          class="dropdown-item"
                          type="button"
                          data-bs-toggle="tooltip"
                          data-bs-placement="left"
                          data-bs-title="Best for reports: copies rich content (title + image + link) for pasting into Word/Google Docs."
                        >
                          <i class="bi bi-filetype-html me-2" aria-hidden="true"></i>HTML package
                        </button>
                      </li>
                      <li><hr class="dropdown-divider"></li>
                      <li><h6 class="dropdown-header">Share to social</h6></li>
                      <li>
                        <button id="tm-share-bluesky" class="dropdown-item" type="button">
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 568 501" class="me-2" style="display: inline-block; vertical-align: text-bottom;">
                            <path d="M123.121 33.664C188.241 82.553 258.281 181.68 284 234.873c25.719-53.192 95.759-152.32 160.879-201.21C491.866-1.611 568-28.906 568 57.947c0 17.346-9.945 145.713-15.778 166.555-20.275 72.453-94.155 90.933-159.875 79.748C507.222 323.8 536.444 388.56 473.333 453.32c-119.86 122.992-172.272-30.859-185.702-70.281-2.462-7.227-3.614-10.608-3.631-7.733-.017-2.875-1.169.506-3.631 7.733-13.43 39.422-65.842 193.273-185.702 70.281-63.111-64.76-33.89-129.52 80.986-149.071-65.72 11.185-139.6-7.295-159.875-79.748C9.945 203.659 0 75.291 0 57.946 0-28.906 76.135-1.612 123.121 33.664Z"/>
                          </svg>Bluesky
                        </button>
                      </li>
                      <li>
                        <button id="tm-share-twitter" class="dropdown-item" type="button">
                          <i class="bi bi-twitter-x me-2" aria-hidden="true"></i>Twitter / X
                        </button>
                      </li>
                    </ul>
                  </div>
                </div>

                <div class="vr mx-2 align-self-stretch"></div>

                <div class="tm-toolbar-group">
                  <div class="btn-group btn-group-sm" role="group" aria-label="Style controls">
                    <button
                      id="tm-editor-style"
                      class="btn btn-outline-secondary tm-icon-btn"
                      type="button"
                      aria-label="Diagram style"
                      data-bs-toggle="tooltip"
                      data-bs-title="Diagram style"
                    >
                      <i class="bi bi-palette" aria-hidden="true"></i>
                    </button>
                  </div>
                </div>


                <div id="tm-viz-hint-wrap" class="tm-viz-hint-wrap ms-2">
                  <button
                    id="tm-viz-hint-dismiss"
                    type="button"
                    class="btn-close tm-viz-hint-dismiss"
                    aria-label="Dismiss"
                    title="Dismiss"
                  ></button>
                  <span id="tm-viz-hint" class="tm-viz-hint small text-muted"></span>
                  <span id="tm-viz-status" class="tm-viz-status small text-muted" aria-live="polite"></span>
                </div>

                <!-- Tips switch: hides the toolbar tips callout AND the in-map contextual hint bubble -->
                <div class="tm-toolbar-group ms-2">
                  <div class="form-check form-switch m-0">
                    <input class="form-check-input" type="checkbox" role="switch" id="tm-tips-toggle" checked />
                    <label class="form-check-label small text-muted" for="tm-tips-toggle">Tips</label>
                  </div>
                </div>
              </div>

              <div id="tm-viz" class="tm-viz"></div>
              <!-- MapScript: Description: ... (rendered below the diagram) -->
              <div id="tm-viz-legend" class="tm-viz-legend small text-muted d-none"></div>

              <!-- Selection drawer: shown when nodes are multi-selected (checkboxes) -->
              <div id="tm-viz-selection-drawer" class="tm-viz-drawer" aria-labelledby="tm-viz-selection-drawer-title">
                <div class="border-bottom bg-white px-3 py-2 d-flex align-items-start justify-content-between gap-3">
                  <div>
                    <div class="fw-semibold" id="tm-viz-selection-drawer-title">Edit nodes</div>
                    <div id="tm-viz-selection-meta" class="small text-muted"></div>
                  </div>
                  <button id="tm-viz-selection-close" type="button" class="btn-close" aria-label="Close"></button>
                </div>
                <div class="row mb-3 g-2">
                  <div class="col-6 d-grid">
                    <button id="tm-clear-selection" type="button" class="btn btn-sm btn-outline-secondary w-100">
                      <i class="bi bi-x-square me-1" aria-hidden="true"></i>
                      Clear selection
                    </button>
                  </div>
                  <div class="col-6 d-grid">
                    <button id="tm-delete-selected" type="button" class="btn btn-sm btn-outline-danger w-100">
                      <i class="bi bi-trash me-1" aria-hidden="true"></i>
                      Delete selected
                    </button>
                  </div>
                </div>
                <div class="p-3">
                  <!-- Unified drawer: edit a single selected node, plus selection operations -->
                  <div class="accordion" id="tm-viz-selection-accordion">
                    <!-- Styling + renaming for exactly 1 selected node -->
                    <div class="accordion-item">
                      <h2 class="accordion-header tm-viz-acc-style" id="tm-viz-selection-acc-node-h">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#tm-viz-selection-acc-node" aria-expanded="true" aria-controls="tm-viz-selection-acc-node">
                          <i class="bi bi-brush me-2" aria-hidden="true"></i>
                          Style or relabel nodes
                        </button>
                      </h2>
                      <div id="tm-viz-selection-acc-node" class="accordion-collapse collapse show" aria-labelledby="tm-viz-selection-acc-node-h" data-bs-parent="#tm-viz-selection-accordion">
                        <div class="accordion-body">
                          <div id="tm-viz-selection-node-edit-hint" class="small text-muted">
                            Select exactly 1 node to edit its label and styling.
                          </div>
                          <div id="tm-viz-selection-node-edit-disabled" class="alert alert-info mt-3 d-none"></div>

                          <!-- Node fields (moved from tm-viz-edit-modal) -->
                          <div id="tm-viz-edit-node-fields" class="mt-3 d-none">
                            <label class="form-label mb-1" for="tm-viz-node-label">Node label</label>
                            <input id="tm-viz-node-label" class="form-control form-control-sm" type="text" />

                            <div class="row g-2 mt-2">
                              <div class="col-12 col-md-5">
                                <label class="form-label mb-1" for="tm-viz-node-fill-color">Fill colour</label>
                                <input id="tm-viz-node-fill-color" class="form-control form-control-sm form-control-color" type="color" value="#ffffff" />
                              </div>
                              <div class="col-12 col-md-7 d-flex align-items-end gap-2">
                                <div class="form-check">
                                  <input class="form-check-input" type="checkbox" value="" id="tm-viz-node-rounded" />
                                  <label class="form-check-label" for="tm-viz-node-rounded">Rounded</label>
                                </div>
                              </div>
                            </div>

                            <div class="row g-2 mt-2">
                              <div class="col-4">
                                <label class="form-label mb-1" for="tm-viz-node-border-width">Border width</label>
                                <input id="tm-viz-node-border-width" class="form-range tm-range-compact" type="range" min="0" max="12" step="1" value="1" />
                              </div>
                              <div class="col-4">
                                <label class="form-label mb-1" for="tm-viz-node-border-style">Border style</label>
                                <!-- UX: <6 options => buttons; keep select as source-of-truth for existing JS -->
                                <select id="tm-viz-node-border-style" class="form-select form-select-sm visually-hidden">
                                  <option value="solid">solid</option>
                                  <option value="dotted">dotted</option>
                                  <option value="dashed">dashed</option>
                                </select>
                                <div id="tm-viz-node-border-style-btns" class="btn-group btn-group-sm" role="group" aria-label="Node border style">
                                  <button type="button" class="btn btn-outline-secondary" data-value="solid">solid</button>
                                  <button type="button" class="btn btn-outline-secondary" data-value="dotted">dotted</button>
                                  <button type="button" class="btn btn-outline-secondary" data-value="dashed">dashed</button>
                                </div>
                              </div>
                              <div class="col-4">
                                <label class="form-label mb-1" for="tm-viz-node-border-color">Border colour</label>
                                <input id="tm-viz-node-border-color" class="form-control form-control-sm form-control-color" type="color" value="#999999" />
                              </div>
                            </div>

                            <div class="mt-2">
                              <div class="mt-1">
                                <label class="form-label mb-1" for="tm-viz-node-text-size">Text size (scale ×)</label>
                                <input id="tm-viz-node-text-size" class="form-range tm-range-compact" type="range" min="0.5" max="2.5" step="0.1" value="1" />
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Selection operations (existing selection drawer contents) -->
                    <div class="accordion-item">
                      <h2 class="accordion-header tm-viz-acc-actions" id="tm-viz-selection-acc-sel-h">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#tm-viz-selection-acc-sel" aria-expanded="false" aria-controls="tm-viz-selection-acc-sel">
                          <i class="bi bi-check2-square me-2" aria-hidden="true"></i>
                          Create, move and group nodes
                        </button>
                      </h2>
                      <div id="tm-viz-selection-acc-sel" class="accordion-collapse collapse" aria-labelledby="tm-viz-selection-acc-sel-h" data-bs-parent="#tm-viz-selection-accordion">
                        <div class="accordion-body">
                          

                          <div class="mb-3 p-3 border rounded bg-light">
                            
                            
                            <div class="fw-semibold mb-1"><i class="bi bi-bounding-box me-2" aria-hidden="true"></i>Group selected nodes</div>
                            <div class="input-group input-group-sm">
                              <input id="tm-viz-selection-group-label" class="form-control" type="text" placeholder="Group Label" autocomplete="off" />
                              <button id="tm-group-selected" type="button" class="btn btn-outline-secondary text-nowrap">
                                <i class="bi bi-bounding-box me-1" aria-hidden="true"></i>
                                Group
                              </button>
                            </div>
                          </div>

                          <div class="mb-3 p-3 border rounded bg-light">
                            <div class="fw-semibold mb-1"><i class="bi bi-box-arrow-up me-2" aria-hidden="true"></i>Move selected nodes into/out of grouping boxes</div>
                            <div class="small text-muted mb-0">
                              Shift+click a <span class="fw-semibold">group box</span> to move the selection into it.
                              Shift+click the <span class="fw-semibold">diagram background</span> to move the selection out of all groups.
                            </div>
                          </div>

                          <div class="mb-0 p-3 border rounded bg-light">
                            <div class="fw-semibold mb-2"><i class="bi bi-link-45deg me-2" aria-hidden="true"></i>Create Links...</div>

                            <div class="mb-3">
                              <div class="fw-semibold">... by clicking a node (or group box) in the diagram.</div>
                            </div>

                            <hr class="my-3" />

                            <div class="mb-0">
                              <div class="fw-semibold">... to new nodes</div>
                              <div class="small text-muted mb-2">Each label creates a node which will be linked to all selected nodes</div>

                            <div id="tm-viz-selection-link-controls">
                              <div id="tm-viz-selection-link-new-labels" class="d-grid gap-2"></div>
                              <button id="tm-viz-selection-link-create-new-btn" type="button" class="btn btn-sm btn-outline-secondary mt-2">
                                <i class="bi bi-plus-square me-1" aria-hidden="true"></i>
                                Create new + link
                              </button>

                              <hr class="my-3" />

                              <div class="row g-3 align-items-center mb-2">
                                <div class="col-auto tm-inline-label-col text-end">
                                  <label class="form-label mb-0" for="tm-viz-selection-link-dir">Direction</label>
                                </div>
                                <div class="col">
                                  <div class="btn-group btn-group-sm" role="group" aria-label="Link direction">
                                    <input type="radio" class="btn-check" name="tm-viz-selection-link-dir" id="tm-viz-selection-link-dir-out" autocomplete="off" checked />
                                    <label class="btn btn-outline-secondary" for="tm-viz-selection-link-dir-out">Selected → clicked</label>

                                    <input type="radio" class="btn-check" name="tm-viz-selection-link-dir" id="tm-viz-selection-link-dir-in" autocomplete="off" />
                                    <label class="btn btn-outline-secondary" for="tm-viz-selection-link-dir-in">Clicked → selected</label>
                                  </div>
                                </div>
                              </div>

                              <div class="row g-3 align-items-center mb-2">
                                <div class="col-auto tm-inline-label-col text-end">
                                  <label class="form-label mb-0" for="tm-viz-selection-link-label">Link label</label>
                                </div>
                                <div class="col">
                                  <input id="tm-viz-selection-link-label" class="form-control form-control-sm" type="text" placeholder="(optional)" autocomplete="off" />
                                </div>
                              </div>

                              <div class="form-check form-switch mt-2">
                                <input id="tm-viz-selection-link-border-enabled" class="form-check-input" type="checkbox" />
                                <label class="form-check-label" for="tm-viz-selection-link-border-enabled">Custom link style</label>
                              </div>
                              <div id="tm-viz-selection-link-border-controls" class="row g-2 mt-2 d-none">
                                <div class="col-4">
                                  <label class="form-label mb-1" for="tm-viz-selection-link-border-width">Link width</label>
                                  <input id="tm-viz-selection-link-border-width" class="form-range tm-range-compact" type="range" min="0" max="12" step="1" value="1" />
                                </div>
                                <div class="col-4">
                                  <label class="form-label mb-1" for="tm-viz-selection-link-border-style">Link style</label>
                                  <!-- UX: <6 options => buttons; keep select as source-of-truth for existing JS -->
                                  <select id="tm-viz-selection-link-border-style" class="form-select form-select-sm visually-hidden">
                                    <option value="solid">solid</option>
                                    <option value="dotted">dotted</option>
                                    <option value="dashed">dashed</option>
                                  </select>
                                  <div id="tm-viz-selection-link-border-style-btns" class="btn-group btn-group-sm" role="group" aria-label="Selection link style">
                                    <button type="button" class="btn btn-outline-secondary" data-value="solid">solid</button>
                                    <button type="button" class="btn btn-outline-secondary" data-value="dotted">dotted</button>
                                    <button type="button" class="btn btn-outline-secondary" data-value="dashed">dashed</button>
                                  </div>
                                </div>
                                <div class="col-4">
                                  <label class="form-label mb-1" for="tm-viz-selection-link-border-color">Link colour</label>
                                  <input id="tm-viz-selection-link-border-color" class="form-control form-control-sm form-control-color" type="color" value="#6c757d" />
                                </div>
                              </div>
                            </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                </div>
              </div>
            </div>
          </section>

          <!-- Templates tab -->
          <section id="tab-templates" class="tm-tab-panel d-none p-3">
            <div class="d-flex align-items-start justify-content-between gap-3 flex-wrap">
              <div>
                <h6 class="mb-1">Templates</h6>
                <div class="small text-muted">
                  Click a template to load it into the editor.
                </div>
              </div>
            </div>

            <hr class="my-3" />

            <div class="mb-4">
              <div class="d-flex align-items-center justify-content-between">
                <h6 class="mb-2">Saved in this browser</h6>
                <div class="small text-muted">LocalStorage</div>
              </div>
              <div class="d-flex align-items-center justify-content-between gap-2 mb-2">
                <div class="small text-muted">Thumbnails are saved per browser.</div>
                <button id="tm-templates-rebuild-thumbs" class="btn btn-sm btn-outline-secondary" type="button">
                  Rebuild thumbnails
                </button>
              </div>
              <div id="tm-templates-saved-empty" class="small text-muted">No saved maps found yet.</div>
              <div id="tm-templates-saved" class="row g-3 d-none"></div>
            </div>

            <div>
              <div class="d-flex align-items-center justify-content-between">
                <h6 class="mb-2">Examples</h6>
                <div class="small text-muted">16</div>
              </div>
              <div id="tm-templates-examples" class="row g-3"></div>
            </div>
          </section>

          <!-- Help tab -->
          <section id="tab-help" class="tm-tab-panel d-none p-3 tm-help-tab">
            <div class="tm-help-header">
              <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                <div class="tm-help-subtabs">
                  <a href="#" class="tm-help-subtab active" data-help-tab="intro">intro</a>
                  <span class="text-muted px-1">|</span>
                  <a href="#" class="tm-help-subtab" data-help-tab="usage">usage</a>
                  <span class="text-muted px-1">|</span>
                  <a href="#" class="tm-help-subtab" data-help-tab="ai">ai</a>
                  <span class="text-muted px-1">|</span>
                  <a href="#" class="tm-help-subtab" data-help-tab="syntax">syntax</a>
                  <span class="text-muted px-1">|</span>
                  <a href="#" class="tm-help-subtab" data-help-tab="faq">faq</a>
                  <span class="text-muted px-1">|</span>
                  <a href="#" class="tm-help-subtab" data-help-tab="quickref">quickref</a>
                  <span id="tm-help-admin-sep" class="text-muted px-1 d-none">|</span>
                  <a id="tm-help-admin-tab" href="#" class="tm-help-subtab d-none" data-help-tab="admin">admin</a>
                </div>

                <!-- Link to standalone help page for the current sub-tab -->
                <a
                  id="tm-help-open"
                  class="small text-muted text-decoration-none"
                  href="./help/intro"
                  target="_blank"
                  rel="noopener"
                >
                  open in new page
                </a>
              </div>
            </div>

            <div id="tm-help-quickref" class="tm-help-quickref">
              <h6 class="mb-2">Quick reference</h6>
              <pre class="tm-help"><code>Title: My new graph
Title position: bottom-left
Background: White
Default node colour: red
Default node shape: rounded
Default node border: 1px dotted green
Direction: top-bottom
Label wrap: 20 characters
Spacing along: 20
Spacing across: 20

A:: Actual text for A[colour=red | border=1px solid blue]
--A grouping box containing B and C
B:: Text for B
----An inner grouping box containing C
C:: Text for C
----
--
F:: some text not in any grouping box

A | Q -> B | C
D -> Needs no alias
D -> E [label=some edgelabel | border=1px solid seagreen | label style=italic | label size=10]
A -> B [seagreen]
A -> B [increases | 1px]</code></pre>
              <div class="small text-muted">
                Notes: comments start with <code>#</code>. Attributes are inside <code>[...]</code> and separated by <code>|</code>.
              </div>
            </div>

            <div id="tm-help-md" class="tm-help-md d-none">Loading help…</div>
          </section>
        </div>
      </section>
    </main>

    <!-- Subtle footer -->
    <footer class="border-top bg-white">
      <div class="container-fluid py-2">
        <div class="d-flex align-items-center justify-content-start small text-muted">
          <!-- Footer links with matching icons (combined) -->
          <div class="tm-footer-icons d-inline-flex align-items-center flex-nowrap text-nowrap">
            <a
              class="d-inline-flex align-items-center gap-1 text-muted text-decoration-none"
              href="https://causalmap.app/"
              title="Causal Map"
              aria-label="Causal Map"
            >
              <img class="tm-footer-favicon" src="https://app.causalmap.app/favicon.png" alt="Causal Map" />
              <span>Causal Map Ltd</span>
            </a>
            <span class="px-2">·</span>
            <a
              class="d-inline-flex align-items-center gap-1 text-muted text-decoration-none"
              href="https://github.com/stevepowell99/theorymaker4"
              title="GitHub"
              aria-label="GitHub"
            >
              <i class="bi bi-github" aria-hidden="true"></i>
              <span>github</span>
            </a>
            <span class="px-2">·</span>
            <a
              class="d-inline-flex align-items-center gap-1 text-muted text-decoration-none"
              href="https://creativecommons.org/licenses/by-nc/4.0/"
              rel="license"
              title="Creative Commons BY-NC 4.0"
              aria-label="Creative Commons BY-NC 4.0"
            >
              <i class="bi bi-cc-circle" aria-hidden="true"></i>
              <i class="bi bi-cc-by" aria-hidden="true"></i>
              <i class="bi bi-cc-nc" aria-hidden="true"></i>
            </a>
          </div>

          <span class="px-2">·</span>

          <!-- Footer message carousel (subtle, rotates every ~10s) -->
          <div id="tm-footer-carousel" class="tm-footer-carousel d-inline-flex align-items-center gap-2">
            <span id="tm-footer-carousel-icon" class="tm-footer-carousel-icon" aria-hidden="true"></span>
            <span class="tm-footer-carousel-text">
              <span id="tm-footer-carousel-prefix"></span>
              <a id="tm-footer-carousel-site" class="tm-footer-carousel-site" href="#" target="_blank" rel="noopener"></a>
              <span id="tm-footer-carousel-suffix"></span>
            </span>
          </div>
        </div>
      </div>
    </footer>

    <!-- Ace Editor (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.6/src-min-noconflict/ace.js" defer></script>

    <!-- Markdown renderer for help.md -->
    <script src="https://cdn.jsdelivr.net/npm/marked@15.0.6/marked.min.js" defer></script>

    <!-- Bootstrap JS (for modal) -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
      defer
    ></script>

    <!-- Intro.js (guided tour) -->
    <script src="https://cdn.jsdelivr.net/npm/intro.js@7.2.0/minified/intro.min.js" defer></script>

    <!-- App logic (module so we can import Graphviz WASM cleanly) -->
    <script type="module" src="./app.js"></script>

    <!-- Style drawer (replaces the old bootstrap modal; edits diagram-wide style settings) -->
    <div id="tm-style-modal" class="tm-viz-drawer" aria-labelledby="tm-style-drawer-title">
      <div class="border-bottom bg-white px-3 py-2 d-flex align-items-start justify-content-between gap-3">
        <div>
          <h2 class="fw-bold fs-4 mb-0" id="tm-style-drawer-title">Diagram Styles</h2>
          <div class="small text-muted">Diagram-wide defaults</div>
        </div>
        <button id="tm-style-close-x" type="button" class="btn-close" aria-label="Close"></button>
      </div>

      <div class="p-3">
        <!-- Always visible: Direction + Spacing -->
        <div class="row g-3 mb-3">
              <div class="col-12 col-md-6">
                <label class="form-label mb-1" for="tm-style-direction">Direction</label>
                <select id="tm-style-direction" class="form-select form-select-sm d-none">
                  <option value="LR">left → right</option>
                  <option value="RL">right → left</option>
                  <option value="TB">top → bottom</option>
                  <option value="BT">bottom → top</option>
                </select>
                <div id="tm-style-direction-btns" class="btn-group btn-group-sm" role="group" aria-label="Direction">
                  <button type="button" class="btn btn-outline-secondary" data-value="LR">→</button>
                  <button type="button" class="btn btn-outline-secondary" data-value="RL">←</button>
                  <button type="button" class="btn btn-outline-secondary" data-value="TB">↓</button>
                  <button type="button" class="btn btn-outline-secondary" data-value="BT">↑</button>
                </div>
              </div>

              <div class="col-12">
                <div class="row g-2">
                  <div class="col-12 col-md-6">
                    <div class="d-flex align-items-center justify-content-between">
                      <label class="form-label mb-1" for="tm-style-rank-gap">Spacing along</label>
                      <div class="small text-muted"><span id="tm-style-rank-gap-val">4</span></div>
                    </div>
                    <input id="tm-style-rank-gap" class="form-range" type="range" min="0" max="20" step="1" value="4" />
                  </div>
                  <div class="col-12 col-md-6">
                    <div class="d-flex align-items-center justify-content-between">
                      <label class="form-label mb-1" for="tm-style-node-gap">Spacing across</label>
                      <div class="small text-muted"><span id="tm-style-node-gap-val">3</span></div>
                    </div>
                    <input id="tm-style-node-gap" class="form-range" type="range" min="0" max="20" step="1" value="3" />
                  </div>
                </div>
              </div>
        </div>

        <!-- Accordion: Presets vs More settings -->
        <div class="accordion" id="tm-style-accordion">
              <!-- Presets panel -->
              <div class="accordion-item">
                <h2 class="accordion-header">
                  <button
                    class="accordion-button fw-bold"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#tm-style-presets-panel"
                    aria-expanded="true"
                    aria-controls="tm-style-presets-panel"
                  >
                    Presets
                  </button>
                </h2>
                <div id="tm-style-presets-panel" class="accordion-collapse collapse show" data-bs-parent="#tm-style-accordion">
                  <div class="accordion-body">
                    <div class="row g-3">
                      <div class="col-12 col-lg-6">
                        <div class="small text-muted mb-1">Colourways</div>
                        <div id="tm-style-presets-colourways" class="tm-style-grid" aria-label="Colourway presets"></div>
                      </div>

                      <div class="col-12 col-lg-6">
                        <div class="fw-bold text-dark mb-1">Styles</div>
                        <div id="tm-style-presets-styles" class="tm-style-grid" aria-label="Style presets"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- More settings panel -->
              <div class="accordion-item">
                <h2 class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#tm-style-more-panel"
                    aria-expanded="false"
                    aria-controls="tm-style-more-panel"
                  >
                    More settings
                  </button>
                </h2>
                <div id="tm-style-more-panel" class="accordion-collapse collapse" data-bs-parent="#tm-style-accordion">
                  <div class="accordion-body">
                    <!-- Diagram section -->
                    <div class="mb-3 p-3 border rounded bg-light">
                      <h6 class="mb-3 fw-bold text-dark">Diagram</h6>
                      <div class="row g-3">
                        <div class="col-12 col-md-6">
                          <label class="form-label mb-1" for="tm-style-background">Background</label>
                          <input id="tm-style-background" class="form-control form-control-sm form-control-color" type="color" value="#ffffff" />
                        </div>
                        <div class="col-12 col-md-6">
                          <label class="form-label mb-1" for="tm-style-text-color">Text colour (title + edge labels)</label>
                          <input id="tm-style-text-color" class="form-control form-control-sm form-control-color" type="color" value="#111827" />
                        </div>
                        <div class="col-12 col-md-6">
                          <div class="d-flex align-items-center justify-content-between">
                            <label class="form-label mb-1" for="tm-style-title-size">Title size</label>
                            <div class="small text-muted"><span id="tm-style-title-size-val">18</span>pt</div>
                          </div>
                          <input id="tm-style-title-size" class="form-range" type="range" min="10" max="36" step="1" value="18" />
                        </div>
                        <div class="col-12 col-md-6">
                          <label class="form-label mb-1" for="tm-style-title-position">Title position</label>
                          <select id="tm-style-title-position" class="form-select form-select-sm d-none">
                            <option value="bottom-left">bottom left</option>
                            <option value="bottom-centre">bottom centre</option>
                            <option value="bottom-right">bottom right</option>
                            <option value="top-left">top left</option>
                            <option value="top-centre">top centre</option>
                            <option value="top-right">top right</option>
                          </select>
                          <div id="tm-style-title-position-btns" class="d-flex flex-column gap-1" role="group" aria-label="Title position">
                            <div class="btn-group btn-group-sm" role="group" aria-label="Title position top row">
                              <button type="button" class="btn btn-outline-secondary" data-value="top-left">TL</button>
                              <button type="button" class="btn btn-outline-secondary" data-value="top-centre">TM</button>
                              <button type="button" class="btn btn-outline-secondary" data-value="top-right">TR</button>
                            </div>
                            <div class="btn-group btn-group-sm" role="group" aria-label="Title position bottom row">
                              <button type="button" class="btn btn-outline-secondary" data-value="bottom-left">BL</button>
                              <button type="button" class="btn btn-outline-secondary" data-value="bottom-centre">BM</button>
                              <button type="button" class="btn btn-outline-secondary" data-value="bottom-right">BR</button>
                            </div>
                          </div>
                        </div>
                        <div class="col-12 col-md-6">
                          <div class="d-flex align-items-center justify-content-between">
                            <label class="form-label mb-1" for="tm-style-label-wrap">Label wrap</label>
                            <div class="small text-muted"><span id="tm-style-label-wrap-val">18</span></div>
                          </div>
                          <input id="tm-style-label-wrap" class="form-range" type="range" min="8" max="40" step="1" value="18" />
                        </div>
                      </div>
                    </div>

                    <!-- Nodes section -->
                    <div class="mb-3 p-3 border rounded bg-light">
                      <h6 class="mb-3 fw-bold text-dark">Nodes</h6>
                      <div class="row g-3">
                        <div class="col-12 col-md-6">
                          <label class="form-label mb-1" for="tm-style-node-fill">Default node colour</label>
                          <input id="tm-style-node-fill" class="form-control form-control-sm form-control-color" type="color" value="#e7f5ff" />
                        </div>
                        <div class="col-12 col-md-6">
                          <label class="form-label mb-1" for="tm-style-default-node-text-color">Default node text colour</label>
                          <input id="tm-style-default-node-text-color" class="form-control form-control-sm form-control-color" type="color" value="#111827" />
                        </div>
                        <div class="col-12 col-md-6">
                          <label class="form-label mb-1" for="tm-style-node-shape">Default node shape</label>
                          <select id="tm-style-node-shape" class="form-select form-select-sm visually-hidden">
                            <option value="">square</option>
                            <option value="rounded">rounded</option>
                          </select>
                          <!-- UX: grouped pair of box icons (not a dropdown) -->
                          <div id="tm-style-node-shape-btns" class="btn-group btn-group-sm" role="group" aria-label="Default node shape">
                            <button type="button" class="btn btn-outline-secondary tm-shape-btn" data-value="" aria-label="square" title="square">
                              <span class="tm-shape-preview" aria-hidden="true"></span>
                            </button>
                            <button type="button" class="btn btn-outline-secondary tm-shape-btn" data-value="rounded" aria-label="rounded" title="rounded">
                              <span class="tm-shape-preview tm-shape-preview-rounded" aria-hidden="true"></span>
                            </button>
                          </div>
                        </div>
                        <div class="col-12 col-md-6">
                          <label class="form-label mb-1" for="tm-style-node-shadow">Default node shadow</label>
                          <select id="tm-style-node-shadow" class="form-select form-select-sm visually-hidden">
                            <option value="none">none</option>
                            <option value="subtle">subtle</option>
                            <option value="medium">medium</option>
                            <option value="strong">strong</option>
                          </select>
                          <div id="tm-style-node-shadow-btns" class="btn-group btn-group-sm" role="group" aria-label="Default node shadow">
                            <button type="button" class="btn btn-outline-secondary" data-value="none">none</button>
                            <button type="button" class="btn btn-outline-secondary" data-value="subtle">subtle</button>
                            <button type="button" class="btn btn-outline-secondary" data-value="medium">medium</button>
                            <button type="button" class="btn btn-outline-secondary" data-value="strong">strong</button>
                          </div>
                        </div>
                        <div class="col-12">
                          <div class="d-flex align-items-center justify-content-between">
                            <label class="form-label mb-1" for="tm-style-node-border-width">Default node border</label>
                            <div class="small text-muted"><span id="tm-style-node-border-width-val">1</span>px</div>
                          </div>
                          <div class="row g-2">
                            <div class="col-12 col-md-4">
                              <input id="tm-style-node-border-width" class="form-range" type="range" min="0" max="6" step="1" value="1" />
                            </div>
                            <div class="col-12 col-md-4">
                              <select id="tm-style-node-border-style" class="form-select form-select-sm visually-hidden">
                                <option value="solid">solid</option>
                                <option value="dotted">dotted</option>
                                <option value="dashed">dashed</option>
                              </select>
                              <div id="tm-style-node-border-style-btns" class="btn-group btn-group-sm" role="group" aria-label="Default node border style">
                                <button type="button" class="btn btn-outline-secondary" data-value="solid">solid</button>
                                <button type="button" class="btn btn-outline-secondary" data-value="dotted">dotted</button>
                                <button type="button" class="btn btn-outline-secondary" data-value="dashed">dashed</button>
                              </div>
                            </div>
                            <div class="col-12 col-md-4">
                              <input id="tm-style-node-border-color" class="form-control form-control-sm form-control-color" type="color" value="#1e90ff" />
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Groups section -->
                    <div class="mb-3 p-3 border rounded bg-light">
                      <h6 class="mb-3 fw-bold text-dark">Groups</h6>
                      <div class="row g-3">
                        <div class="col-12 col-md-6">
                          <label class="form-label mb-1" for="tm-style-default-group-text-color">Default group text colour</label>
                          <input id="tm-style-default-group-text-color" class="form-control form-control-sm form-control-color" type="color" value="#111827" />
                        </div>
                      </div>
                    </div>

                    <!-- Links section -->
                    <div class="mb-3 p-3 border rounded bg-light">
                      <h6 class="mb-3 fw-bold text-dark">Links</h6>
                      <div class="row g-3">
                        <div class="col-12 col-md-6">
                          <label class="form-label mb-1" for="tm-style-link-color">Default link colour</label>
                          <input id="tm-style-link-color" class="form-control form-control-sm form-control-color" type="color" value="#6c757d" />
                        </div>
                        <div class="col-12 col-md-6">
                          <label class="form-label mb-1" for="tm-style-link-style">Default link style</label>
                          <select id="tm-style-link-style" class="form-select form-select-sm visually-hidden">
                            <option value="">(auto)</option>
                            <option value="solid">solid</option>
                            <option value="dotted">dotted</option>
                            <option value="dashed">dashed</option>
                          </select>
                          <div id="tm-style-link-style-btns" class="btn-group btn-group-sm" role="group" aria-label="Default link style">
                            <button type="button" class="btn btn-outline-secondary" data-value="">auto</button>
                            <button type="button" class="btn btn-outline-secondary" data-value="solid">solid</button>
                            <button type="button" class="btn btn-outline-secondary" data-value="dotted">dotted</button>
                            <button type="button" class="btn btn-outline-secondary" data-value="dashed">dashed</button>
                          </div>
                        </div>
                        <div class="col-12 col-md-6">
                          <div class="d-flex align-items-center justify-content-between">
                            <label class="form-label mb-1" for="tm-style-link-width">Default link width</label>
                            <div class="small text-muted"><span id="tm-style-link-width-val">1</span>px</div>
                          </div>
                          <input id="tm-style-link-width" class="form-range" type="range" min="1" max="6" step="1" value="1" />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
        </div>
      </div>

      <div class="border-top bg-white px-3 py-2 d-flex justify-content-end">
        <button type="button" class="btn btn-outline-secondary" id="tm-style-apply">Close</button>
      </div>
    </div>

    <!-- Title-only drawer (click the title in the diagram) -->
    <div id="tm-title-modal" class="tm-viz-drawer" aria-labelledby="tm-title-drawer-title">
      <div class="border-bottom bg-white px-3 py-2 d-flex align-items-start justify-content-between gap-3">
        <div>
          <div class="fw-semibold" id="tm-title-drawer-title">Title</div>
        </div>
        <button id="tm-title-close-x" type="button" class="btn-close" aria-label="Close"></button>
      </div>

      <div class="p-3">
        <div class="row g-3">
          <div class="col-12">
            <label class="form-label mb-1" for="tm-title-text">Title</label>
            <input id="tm-title-text" class="form-control form-control-sm" type="text" placeholder="(no title)" />
            <div class="small text-muted mt-1">This edits the <code>Title:</code> line in the editor.</div>
          </div>
          <div class="col-12">
            <label class="form-label mb-1" for="tm-title-text-color">Colour</label>
            <input id="tm-title-text-color" class="form-control form-control-sm form-control-color" type="color" value="#111827" />
          </div>
          <div class="col-12">
            <div class="d-flex align-items-center justify-content-between">
              <label class="form-label mb-1" for="tm-title-size">Font size</label>
              <div class="small text-muted"><span id="tm-title-size-val">18</span>pt</div>
            </div>
            <input id="tm-title-size" class="form-range" type="range" min="10" max="36" step="1" value="18" />
          </div>
          <div class="col-12">
            <label class="form-label mb-1" for="tm-title-position">Position</label>
            <select id="tm-title-position" class="form-select form-select-sm d-none">
              <option value="bottom-left">bottom left</option>
              <option value="bottom-centre">bottom centre</option>
              <option value="bottom-right">bottom right</option>
              <option value="top-left">top left</option>
              <option value="top-centre">top centre</option>
              <option value="top-right">top right</option>
            </select>
            <div id="tm-title-position-btns" class="d-flex flex-column gap-1" role="group" aria-label="Title position">
              <div class="btn-group btn-group-sm" role="group" aria-label="Title position top row">
                <button type="button" class="btn btn-outline-secondary" data-value="top-left">TL</button>
                <button type="button" class="btn btn-outline-secondary" data-value="top-centre">TM</button>
                <button type="button" class="btn btn-outline-secondary" data-value="top-right">TR</button>
              </div>
              <div class="btn-group btn-group-sm" role="group" aria-label="Title position bottom row">
                <button type="button" class="btn btn-outline-secondary" data-value="bottom-left">BL</button>
                <button type="button" class="btn btn-outline-secondary" data-value="bottom-centre">BM</button>
                <button type="button" class="btn btn-outline-secondary" data-value="bottom-right">BR</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="border-top bg-white px-3 py-2 d-flex justify-content-end">
        <button id="tm-title-close" type="button" class="btn btn-outline-secondary">Close</button>
      </div>
    </div>

    <!-- Single setting-line drawer (when cursor is on a "Key: Value" style line in the editor) -->
    <div id="tm-setting-line-modal" class="tm-viz-drawer" aria-labelledby="tm-setting-line-modal-title">
      <div class="border-bottom bg-white px-3 py-2 d-flex align-items-start justify-content-between gap-3">
        <div>
          <div class="fw-semibold" id="tm-setting-line-modal-title">Edit setting</div>
          <div id="tm-setting-line-modal-meta" class="small text-muted"></div>
        </div>
        <button id="tm-setting-line-close-x" type="button" class="btn-close" aria-label="Close"></button>
      </div>

      <div class="p-3">
        <div id="tm-setting-line-modal-body"></div>
      </div>

      <div class="border-top bg-white px-3 py-2 d-flex justify-content-end">
        <button id="tm-setting-line-close" type="button" class="btn btn-outline-secondary">Close</button>
      </div>
    </div>

    <!-- Editor save modal (admin-only) -->
    <div class="modal fade" id="tm-save-modal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Save</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="small text-muted">
              Choose where to save this map (admin only).
            </div>
            <textarea id="tm-save-snippet" class="form-control form-control-sm mt-3 d-none" rows="10" readonly></textarea>
            <div id="tm-save-snippet-hint" class="small text-muted mt-2 d-none">
              Copied to clipboard. Paste into <code>GALLERY_EXAMPLES</code> in <code>app.js</code>.
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-outline-primary" id="tm-save-local">Save to this browser</button>
            <button type="button" class="btn btn-primary" id="tm-save-example">Copy standard example snippet</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Viz edit drawer (node/link interactivity; replaces the old bootstrap modal) -->
    <div id="tm-viz-edit-modal" class="tm-viz-drawer" aria-labelledby="tm-viz-edit-modal-title">
      <div class="border-bottom bg-white px-3 py-2 d-flex align-items-start justify-content-between gap-3">
        <div class="fw-semibold" id="tm-viz-edit-modal-title">Edit</div>
        <button id="tm-viz-edit-close-x" type="button" class="btn-close" aria-label="Close"></button>
      </div>

      <div class="p-3">
        <div id="tm-viz-edit-meta" class="small text-muted"></div>

            <!-- Shown when the clicked thing can't be edited via widgets (implicit / multi-edge line) -->
            <div id="tm-viz-edit-disabled" class="alert alert-info mt-3 d-none"></div>

            <!-- Node fields moved into the Selection drawer (unified selection + edit UI) -->

            <!-- Grouping box (cluster) fields -->
            <div id="tm-viz-edit-cluster-fields" class="mt-3 d-none">
              <div class="accordion" id="tm-viz-cluster-accordion">
                <div class="accordion-item">
                  <h2 class="accordion-header tm-viz-acc-style" id="tm-viz-cluster-acc-style-h">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#tm-viz-cluster-acc-style" aria-expanded="true" aria-controls="tm-viz-cluster-acc-style">
                      <i class="bi bi-bounding-box me-2" aria-hidden="true"></i>
                      Style or relabel groups
                    </button>
                  </h2>
                  <div id="tm-viz-cluster-acc-style" class="accordion-collapse collapse show" aria-labelledby="tm-viz-cluster-acc-style-h" data-bs-parent="#tm-viz-cluster-accordion">
                    <div class="accordion-body">
                      <label class="form-label mb-1" for="tm-viz-cluster-label">Box title</label>
                      <input id="tm-viz-cluster-label" class="form-control form-control-sm" type="text" />

                      <!-- Row 1: Border controls -->
                      <div class="row g-2 mt-2 align-items-end">
                        <div class="col-4">
                          <label class="form-label mb-1" for="tm-viz-cluster-border-width">Border width</label>
                          <input id="tm-viz-cluster-border-width" class="form-range tm-range-compact" type="range" min="0" max="12" step="1" value="1" />
                        </div>
                        <div class="col-4">
                          <label class="form-label mb-1" for="tm-viz-cluster-border-style">Border style</label>
                          <!-- UX: <6 options => buttons; keep select as source-of-truth for existing JS -->
                          <select id="tm-viz-cluster-border-style" class="form-select form-select-sm visually-hidden">
                            <option value="solid">solid</option>
                            <option value="dotted">dotted</option>
                            <option value="dashed">dashed</option>
                          </select>
                          <div id="tm-viz-cluster-border-style-btns" class="btn-group btn-group-sm" role="group" aria-label="Group box border style">
                            <button type="button" class="btn btn-outline-secondary" data-value="solid">solid</button>
                            <button type="button" class="btn btn-outline-secondary" data-value="dotted">dotted</button>
                            <button type="button" class="btn btn-outline-secondary" data-value="dashed">dashed</button>
                          </div>
                        </div>
                        <div class="col-4">
                          <label class="form-label mb-1" for="tm-viz-cluster-border-color">Border colour</label>
                          <input id="tm-viz-cluster-border-color" class="form-control form-control-sm form-control-color" type="color" value="#cccccc" />
                        </div>
                      </div>

                      <!-- Row 2: Background + title -->
                      <div class="row g-2 mt-2 align-items-end">
                        <div class="col-4">
                          <label class="form-label mb-1" for="tm-viz-cluster-fill">Background colour</label>
                          <input id="tm-viz-cluster-fill" class="form-control form-control-sm form-control-color" type="color" value="#ffffff" />
                        </div>
                        <div class="col-4">
                          <label class="form-label mb-1" for="tm-viz-cluster-text-colour">Title text colour</label>
                          <input id="tm-viz-cluster-text-colour" class="form-control form-control-sm form-control-color" type="color" value="#111827" />
                        </div>
                        <div class="col-4">
                          <label class="form-label mb-1" for="tm-viz-cluster-text-size">Title size (scale ×)</label>
                          <input id="tm-viz-cluster-text-size" class="form-range tm-range-compact" type="range" min="0.5" max="2.5" step="0.1" value="1" />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="accordion-item">
                  <h2 class="accordion-header tm-viz-acc-actions" id="tm-viz-cluster-acc-links-h">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#tm-viz-cluster-acc-links" aria-expanded="false" aria-controls="tm-viz-cluster-acc-links">
                      <i class="bi bi-link-45deg me-2" aria-hidden="true"></i>
                      Create links
                    </button>
                  </h2>
                  <div id="tm-viz-cluster-acc-links" class="accordion-collapse collapse" aria-labelledby="tm-viz-cluster-acc-links-h" data-bs-parent="#tm-viz-cluster-accordion">
                    <div class="accordion-body">
                      <div class="small text-muted mb-2">Click a node (or another group box) to create link(s).</div>

                      <div id="tm-viz-cluster-link-controls">
                        <div id="tm-viz-cluster-link-new-labels" class="d-grid gap-2"></div>
                        <button id="tm-viz-cluster-link-create-new-btn" type="button" class="btn btn-sm btn-outline-secondary mt-2">
                          <i class="bi bi-plus-square me-1" aria-hidden="true"></i>
                          Create new + link
                        </button>
                        <div class="small text-muted mt-2">Each label creates a node and links it to all selected group box(es).</div>

                        <hr class="my-3" />

                        <label class="form-label mb-1 d-block">Direction</label>
                        <div class="btn-group btn-group-sm mb-2" role="group" aria-label="Link direction">
                          <input type="radio" class="btn-check" name="tm-viz-cluster-link-dir" id="tm-viz-cluster-link-dir-out" autocomplete="off" checked />
                          <label class="btn btn-outline-secondary" for="tm-viz-cluster-link-dir-out">Selected → clicked</label>

                          <input type="radio" class="btn-check" name="tm-viz-cluster-link-dir" id="tm-viz-cluster-link-dir-in" autocomplete="off" />
                          <label class="btn btn-outline-secondary" for="tm-viz-cluster-link-dir-in">Clicked → selected</label>
                        </div>

                        <label class="form-label mb-1 d-block" for="tm-viz-cluster-link-label">Link label</label>
                        <input id="tm-viz-cluster-link-label" class="form-control form-control-sm mb-2" type="text" placeholder="(optional)" autocomplete="off" />

                        <div class="form-check form-switch mt-2">
                          <input id="tm-viz-cluster-link-border-enabled" class="form-check-input" type="checkbox" />
                          <label class="form-check-label" for="tm-viz-cluster-link-border-enabled">Custom link style</label>
                        </div>
                        <div id="tm-viz-cluster-link-border-controls" class="row g-2 mt-2 d-none">
                          <div class="col-4">
                            <label class="form-label mb-1" for="tm-viz-cluster-link-border-width">Link width</label>
                            <input id="tm-viz-cluster-link-border-width" class="form-range tm-range-compact" type="range" min="0" max="12" step="1" value="1" />
                          </div>
                          <div class="col-4">
                            <label class="form-label mb-1" for="tm-viz-cluster-link-border-style">Link style</label>
                            <!-- UX: <6 options => buttons; keep select as source-of-truth for existing JS -->
                            <select id="tm-viz-cluster-link-border-style" class="form-select form-select-sm visually-hidden">
                              <option value="solid">solid</option>
                              <option value="dotted">dotted</option>
                              <option value="dashed">dashed</option>
                            </select>
                            <div id="tm-viz-cluster-link-border-style-btns" class="btn-group btn-group-sm" role="group" aria-label="Group link style">
                              <button type="button" class="btn btn-outline-secondary" data-value="solid">solid</button>
                              <button type="button" class="btn btn-outline-secondary" data-value="dotted">dotted</button>
                              <button type="button" class="btn btn-outline-secondary" data-value="dashed">dashed</button>
                            </div>
                          </div>
                          <div class="col-4">
                            <label class="form-label mb-1" for="tm-viz-cluster-link-border-color">Link colour</label>
                            <input id="tm-viz-cluster-link-border-color" class="form-control form-control-sm form-control-color" type="color" value="#6c757d" />
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Edge fields -->
            <div id="tm-viz-edit-edge-fields" class="mt-3 d-none">
              <div class="row g-2">
                <div class="col-12 col-md-6">
                  <label class="form-label mb-1" for="tm-viz-edge-from">Source</label>
                  <select id="tm-viz-edge-from" class="form-select form-select-sm"></select>
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label mb-1" for="tm-viz-edge-to">Target</label>
                  <select id="tm-viz-edge-to" class="form-select form-select-sm"></select>
                </div>
              </div>

              <label class="form-label mb-1" for="tm-viz-edge-label">Link label</label>
              <input id="tm-viz-edge-label" class="form-control form-control-sm" type="text" />

              <div class="row g-2 mt-2">
                <div class="col-4">
                  <label class="form-label mb-1" for="tm-viz-edge-border-width">Link width</label>
                  <input id="tm-viz-edge-border-width" class="form-range tm-range-compact" type="range" min="0" max="12" step="1" value="1" />
                </div>
                <div class="col-4">
                  <label class="form-label mb-1" for="tm-viz-edge-border-style">Link style</label>
                  <!-- UX: <6 options => buttons; keep select as source-of-truth for existing JS -->
                  <select id="tm-viz-edge-border-style" class="form-select form-select-sm visually-hidden">
                    <option value="solid">solid</option>
                    <option value="dotted">dotted</option>
                    <option value="dashed">dashed</option>
                  </select>
                  <div id="tm-viz-edge-border-style-btns" class="btn-group btn-group-sm" role="group" aria-label="Link style">
                    <button type="button" class="btn btn-outline-secondary" data-value="solid">solid</button>
                    <button type="button" class="btn btn-outline-secondary" data-value="dotted">dotted</button>
                    <button type="button" class="btn btn-outline-secondary" data-value="dashed">dashed</button>
                  </div>
                </div>
                <div class="col-4">
                  <label class="form-label mb-1" for="tm-viz-edge-border-color">Link colour</label>
                  <input id="tm-viz-edge-border-color" class="form-control form-control-sm form-control-color" type="color" value="#999999" />
                </div>
              </div>
            </div>
      </div>

      <div class="border-top bg-white px-3 py-2 d-flex justify-content-end gap-2">
        <button type="button" class="btn btn-outline-danger" id="tm-viz-edit-delete">Delete</button>
        <button type="button" class="btn btn-outline-secondary" id="tm-viz-edit-save">Close</button>
      </div>
    </div>

    <!-- Ace editor popover: style the current line (node/link) -->
    <div id="tm-ace-style-popover" class="tm-ace-popover d-none" role="dialog" aria-label="Style this line">
      <div class="tm-ace-popover-inner">
        <div id="tm-ace-style-meta" class="small text-muted"></div>

        <!-- Shown when the current line isn't a node or a link -->
        <div id="tm-ace-style-none" class="small text-muted d-none">
          Put the cursor on a node line (<code>ID:: ...</code>), a group line (<code>--...</code>), a title line (<code>Title: ...</code>), or a link line (<code>A -&gt; B</code>) to style it.
        </div>

        <!-- Node styling -->
        <div id="tm-ace-style-node" class="d-none">
          <div class="d-flex align-items-center justify-content-between">
            <div class="fw-semibold">Node styling</div>
          </div>

          <div class="mt-2">
            <div class="form-check form-switch">
              <input id="tm-ace-style-node-fill-enabled" class="form-check-input" type="checkbox" />
              <label class="form-check-label" for="tm-ace-style-node-fill-enabled">Override fill colour</label>
            </div>
            <input id="tm-ace-style-node-fill" class="form-control form-control-sm form-control-color mt-1" type="color" value="#ffffff" />
          </div>

          <div class="mt-2">
            <div class="form-check form-switch">
              <input id="tm-ace-style-node-border-enabled" class="form-check-input" type="checkbox" />
              <label class="form-check-label" for="tm-ace-style-node-border-enabled">Override border</label>
            </div>
            <div class="row g-2 mt-1">
              <div class="col-4">
                <label class="form-label mb-1" for="tm-ace-style-node-border-width">Width</label>
                <input id="tm-ace-style-node-border-width" class="form-range tm-range-compact" type="range" min="0" max="12" step="1" value="1" />
              </div>
              <div class="col-4">
                <label class="form-label mb-1" for="tm-ace-style-node-border-style">Style</label>
                <!-- UX: <6 options => buttons; keep select as source-of-truth for existing JS -->
                <select id="tm-ace-style-node-border-style" class="form-select form-select-sm visually-hidden">
                  <option value="solid">solid</option>
                  <option value="dotted">dotted</option>
                  <option value="dashed">dashed</option>
                </select>
                <div id="tm-ace-style-node-border-style-btns" class="btn-group btn-group-sm" role="group" aria-label="Node border style">
                  <button type="button" class="btn btn-outline-secondary" data-value="solid">solid</button>
                  <button type="button" class="btn btn-outline-secondary" data-value="dotted">dotted</button>
                  <button type="button" class="btn btn-outline-secondary" data-value="dashed">dashed</button>
                </div>
              </div>
              <div class="col-4">
                <label class="form-label mb-1" for="tm-ace-style-node-border-color">Colour</label>
                <input id="tm-ace-style-node-border-color" class="form-control form-control-sm form-control-color" type="color" value="#999999" />
              </div>
            </div>
          </div>

          <div class="mt-2">
            <div class="form-check">
              <input id="tm-ace-style-node-rounded" class="form-check-input" type="checkbox" />
              <label class="form-check-label" for="tm-ace-style-node-rounded">Rounded</label>
            </div>
          </div>

          <div class="mt-2">
            <div class="form-check form-switch">
              <input id="tm-ace-style-node-text-size-enabled" class="form-check-input" type="checkbox" />
              <label class="form-check-label" for="tm-ace-style-node-text-size-enabled">Override text size</label>
            </div>
            <div class="mt-1">
              <label class="form-label mb-1" for="tm-ace-style-node-text-size">Scale (×)</label>
              <input id="tm-ace-style-node-text-size" class="form-range tm-range-compact" type="range" min="0.5" max="2.5" step="0.1" value="1" />
            </div>
          </div>
        </div>

        <!-- Grouping box (cluster) styling -->
        <div id="tm-ace-style-cluster" class="d-none">
          <div class="d-flex align-items-center justify-content-between">
            <div class="fw-semibold">Group box styling</div>
          </div>

          <div class="mt-2">
            <div class="form-check form-switch">
              <input id="tm-ace-style-cluster-fill-enabled" class="form-check-input" type="checkbox" />
              <label class="form-check-label" for="tm-ace-style-cluster-fill-enabled">Override fill colour</label>
            </div>
            <input id="tm-ace-style-cluster-fill" class="form-control form-control-sm form-control-color mt-1" type="color" value="#ffffff" />
          </div>

          <div class="mt-2">
            <div class="form-check form-switch">
              <input id="tm-ace-style-cluster-border-enabled" class="form-check-input" type="checkbox" />
              <label class="form-check-label" for="tm-ace-style-cluster-border-enabled">Override border</label>
            </div>
            <div class="row g-2 mt-1">
              <div class="col-4">
                <label class="form-label mb-1" for="tm-ace-style-cluster-border-width">Width</label>
                <input id="tm-ace-style-cluster-border-width" class="form-range tm-range-compact" type="range" min="0" max="12" step="1" value="1" />
              </div>
              <div class="col-4">
                <label class="form-label mb-1" for="tm-ace-style-cluster-border-style">Style</label>
                <!-- UX: <6 options => buttons; keep select as source-of-truth for existing JS -->
                <select id="tm-ace-style-cluster-border-style" class="form-select form-select-sm visually-hidden">
                  <option value="solid">solid</option>
                  <option value="dotted">dotted</option>
                  <option value="dashed">dashed</option>
                </select>
                <div id="tm-ace-style-cluster-border-style-btns" class="btn-group btn-group-sm" role="group" aria-label="Group box border style">
                  <button type="button" class="btn btn-outline-secondary" data-value="solid">solid</button>
                  <button type="button" class="btn btn-outline-secondary" data-value="dotted">dotted</button>
                  <button type="button" class="btn btn-outline-secondary" data-value="dashed">dashed</button>
                </div>
              </div>
              <div class="col-4">
                <label class="form-label mb-1" for="tm-ace-style-cluster-border-color">Colour</label>
                <input id="tm-ace-style-cluster-border-color" class="form-control form-control-sm form-control-color" type="color" value="#cccccc" />
              </div>
            </div>
          </div>

          <div class="mt-2">
            <div class="form-check form-switch">
              <input id="tm-ace-style-cluster-text-colour-enabled" class="form-check-input" type="checkbox" />
              <label class="form-check-label" for="tm-ace-style-cluster-text-colour-enabled">Override title text colour</label>
            </div>
            <input id="tm-ace-style-cluster-text-colour" class="form-control form-control-sm form-control-color mt-1" type="color" value="#111827" />
          </div>

          <div class="mt-2">
            <div class="form-check form-switch">
              <input id="tm-ace-style-cluster-text-size-enabled" class="form-check-input" type="checkbox" />
              <label class="form-check-label" for="tm-ace-style-cluster-text-size-enabled">Override title text size</label>
            </div>
            <div class="mt-1">
              <label class="form-label mb-1" for="tm-ace-style-cluster-text-size">Scale (×)</label>
              <input id="tm-ace-style-cluster-text-size" class="form-range tm-range-compact" type="range" min="0.5" max="2.5" step="0.1" value="1" />
            </div>
          </div>
        </div>

        <!-- Diagram title styling (Title: ... [ ... ]) -->
        <div id="tm-ace-style-title" class="d-none">
          <div class="d-flex align-items-center justify-content-between">
            <div class="fw-semibold">Title styling</div>
          </div>

          <div class="mt-2">
            <div class="form-check form-switch">
              <input id="tm-ace-style-title-text-colour-enabled" class="form-check-input" type="checkbox" />
              <label class="form-check-label" for="tm-ace-style-title-text-colour-enabled">Override title colour</label>
            </div>
            <input id="tm-ace-style-title-text-colour" class="form-control form-control-sm form-control-color mt-1" type="color" value="#111827" />
          </div>

          <div class="mt-2">
            <div class="form-check form-switch">
              <input id="tm-ace-style-title-text-size-enabled" class="form-check-input" type="checkbox" />
              <label class="form-check-label" for="tm-ace-style-title-text-size-enabled">Override title size</label>
            </div>
            <div class="mt-1">
              <label class="form-label mb-1" for="tm-ace-style-title-text-size">Size (pt)</label>
              <input id="tm-ace-style-title-text-size" class="form-range tm-range-compact" type="range" min="10" max="36" step="1" value="18" />
            </div>
          </div>
        </div>

        <!-- Link styling -->
        <div id="tm-ace-style-edge" class="d-none">
          <div class="d-flex align-items-center justify-content-between">
            <div class="fw-semibold">Link styling</div>
          </div>

          <div class="mt-2">
            <label class="form-label mb-1" for="tm-ace-style-edge-label">Label</label>
            <input id="tm-ace-style-edge-label" class="form-control form-control-sm" type="text" placeholder="(optional)" />
          </div>

          <div class="mt-2">
            <div class="form-check form-switch">
              <input id="tm-ace-style-edge-border-enabled" class="form-check-input" type="checkbox" />
              <label class="form-check-label" for="tm-ace-style-edge-border-enabled">Override link style</label>
            </div>
            <div class="row g-2 mt-1">
              <div class="col-4">
                <label class="form-label mb-1" for="tm-ace-style-edge-border-width">Link width</label>
                <input id="tm-ace-style-edge-border-width" class="form-range tm-range-compact" type="range" min="0" max="12" step="1" value="1" />
              </div>
              <div class="col-4">
                <label class="form-label mb-1" for="tm-ace-style-edge-border-style">Link style</label>
                <!-- UX: <6 options => buttons; keep select as source-of-truth for existing JS -->
                <select id="tm-ace-style-edge-border-style" class="form-select form-select-sm visually-hidden">
                  <option value="solid">solid</option>
                  <option value="dotted">dotted</option>
                  <option value="dashed">dashed</option>
                </select>
                <div id="tm-ace-style-edge-border-style-btns" class="btn-group btn-group-sm" role="group" aria-label="Link style">
                  <button type="button" class="btn btn-outline-secondary" data-value="solid">solid</button>
                  <button type="button" class="btn btn-outline-secondary" data-value="dotted">dotted</button>
                  <button type="button" class="btn btn-outline-secondary" data-value="dashed">dashed</button>
                </div>
              </div>
              <div class="col-4">
                <label class="form-label mb-1" for="tm-ace-style-edge-border-color">Link colour</label>
                <input id="tm-ace-style-edge-border-color" class="form-control form-control-sm form-control-color" type="color" value="#999999" />
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex align-items-center gap-2 mt-2">
          <button id="tm-ace-style-apply" class="btn btn-sm btn-outline-secondary" type="button">Close</button>
        </div>
      </div>
    </div>

    <!-- Cursor-adjacent style button (appears near the cursor when the current line is styleable) -->
    <button
      id="tm-ace-cursor-style-btn"
      class="btn btn-sm btn-outline-secondary tm-ace-cursor-style-btn d-none d-inline-flex align-items-center gap-1"
      type="button"
      aria-label="Style this line"
      title="Style this line"
    >
      <i class="bi bi-brush" aria-hidden="true"></i>
      <span data-tm-label>Style</span>
    </button>
        <!-- GoatCounter: track only the initial (landing) URL path; NEVER include the hash because it contains the map content (#m=...) -->
        <script>
          window.goatcounter = {
            // Purpose: ensure we only ever send a stable, non-sensitive page path (no #hash).
            // This still counts only on page load unless we explicitly call goatcounter.count() elsewhere (we don't).
            path: function () {
              // WARNING: location.hash contains full map content (#m=...), so we must not send it.
              // Instead we send a short non-reversible fingerprint so you can see "returns to same map" patterns.
              function fnv1a32hex(str) {
                let h = 0x811c9dc5; // FNV-1a 32-bit offset basis
                for (let i = 0; i < str.length; i++) {
                  h ^= str.charCodeAt(i);
                  // h *= 16777619 (as shifts to keep it fast + deterministic in JS)
                  h = (h + ((h << 1) + (h << 4) + (h << 7) + (h << 8) + (h << 24))) >>> 0;
                }
                return h.toString(16).padStart(8, "0");
              }

              const base = location.pathname + location.search;
              if (!location.hash) return base;
              const sep = base.includes("?") ? "&" : "?";
              return `${base}${sep}gc_map=${fnv1a32hex(location.hash)}`;
            },
          };
        </script>
        <script data-goatcounter="https://theorymaker.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
  </body>
</html>


